---
title: "对 C/C++ 程序体积的极致裁剪"
description: "本文仅代表个人观点，欢迎留言讨论"
date: 2022-02-28T15:45:19-05:00
lastmod: 2022-03-06T23:09:04-05:00
draft: false
tags: [C/C++]
categories: IT
---

# 起因
程序的分发一直是困扰各大程序员的老大难问题，尤其是在小程序的分发上。  
如果你只是写了个功能很有限的小程序，却要拖家带口 几十M 的运行时，我相信，用户一定会觉得不值得的。  

**如果你以“现在硬盘白菜价了”或者“都 5G 时代了，网络带宽早不值钱了”这种理由来反驳我，那么请立即关闭我的这篇博文，因为这不是写给你看的。**

# 方法
## 1.动态调用运行时
只要目标设备包含了程序所需的运行时和依赖库，就可以通过动态调用的方式缩小体积。
### *nix
这在 *nix 平台下不是问题，因为必定包含可用的 C/C++ 运行时，又在程序库方面做到了模块化，在使用包管理器的情况下只需要指定对应的依赖，否则就只能让用户手动去安装了。  
如果不想麻烦用户，又不使用包管理器，那么就只有减少依赖，只使用目标平台必定包含的库了。
### Windows
Windows 并没有做到程序库方面的模块化，除了一些基本的 C/C++ 运行时库，所以只有减少依赖一种方法。  
但如果要兼容老版本系统的话，必定包含的库就极其有限，甚至连部分基本的 C/C++ 运行时库也不是必定包含，这时候要么麻烦用户，要么就只能用老版本的运行时库了。
#### 1.使用 Visual C++ 6.0
用 VC6.0 编译出的 C/C++ 程序，运行时就只有 msvcrt.dll 这一个库，而这个库从 Windows 2000 起就必定包含在系统中了。
#### 2.使用 msvcrt 版本的 MinGW 并且不使用和 msvcrt 不支持的 C++ 功能
如果不想用 VC6.0 这种停止维护多年的编译器，又想保证兼容性和裁剪体积，那么使用 msvcrt 版本的 MinGW 并且不使用 msvcrt 不支持的 C++ 功能也是一种不错的方案。  
这种方案下，msvcrt 版本的 MinGW 编译出的 C/C++ 程序和 VC6.0 一样，运行时只有 msvcrt.dll 一个库。

## 2.调整编译器参数
我想这个不用我多说，指定编译器优化代码和不插入调试信息等属于基本功。
## 3.使用压缩壳
UPX、ASPack 等压缩壳可以压缩程序体积，但会让程序占用额外的内存（因为要把压缩后的程序解压到内存里）和拖慢启动时间（虽然也不至于拖慢太多）。  
对于这种方法，我的建议是：按自己的需求来。

# 感想
写完之后再想想，实际上现在真没必要这么抠......这年头 5M 以下的小工具基本都在用户的可接受范围内吧，而未经压缩的 20M...30M 的可执行文件压缩一下也基本能到 5M 以下吧。